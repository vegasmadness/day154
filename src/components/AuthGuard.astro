---
// Remove server-side auth check as it doesn't work properly with Supabase in Astro
// Client-side authentication will handle the redirect
---

<!-- Admin authentication guard -->
<slot />

<script>
  import { supabase } from '../utils/supabase';

  async function checkAuth() {
    try {
      const { data: { user }, error } = await supabase.auth.getUser();
      
      if (error || !user) {
        // Add a small delay to prevent immediate redirect loops
        setTimeout(() => {
          window.location.href = '/admin';
        }, 100);
        return;
      }
      
      console.log('Authenticated admin user:', user.email);
    } catch (error) {
      console.error('Auth check error:', error);
      // Add delay for error case too
      setTimeout(() => {
        window.location.href = '/admin';
      }, 100);
    }
  }

  // Add a small delay before running auth check to let page settle
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkAuth, 200);
  });

  // Listen for auth state changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_OUT' || !session) {
      // Only redirect on explicit sign out, not on initial load
      if (event === 'SIGNED_OUT') {
        window.location.href = '/admin';
      }
    }
  });
</script>