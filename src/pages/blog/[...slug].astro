---
import { type CollectionEntry, getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';

export async function getStaticPaths() {
  // Get all blog posts from the content collection
  const posts = await getCollection('blog', ({ data }) => {
    // Filter out draft posts in production
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  
  // Generate static paths for each blog post
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<'blog'>;
};

const { post } = Astro.props;

// Handle missing post (shouldn't happen with static generation, but good for safety)
if (!post) {
  return Astro.redirect('/404');
}

// Render the post content
const { Content } = await post.render();

// Calculate reading time and word count
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Generate structured data for SEO (JSON-LD)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "image": post.data.heroImage ? new URL(post.data.heroImage, Astro.url).href : undefined,
  "datePublished": post.data.pubDate.toISOString(),
  "dateModified": post.data.updatedDate ? post.data.updatedDate.toISOString() : post.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": "StoryHub Author"
  },
  "publisher": {
    "@type": "Organization",
    "name": "StoryHub",
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/favicon.svg", Astro.url).href
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  },
  "keywords": post.data.tags?.join(", "),
  "wordCount": wordCount,
  "articleSection": "Blog"
};

// Generate canonical URL
const canonicalURL = new URL(`/blog/${post.slug}/`, Astro.site || 'http://localhost:3000');
---

<BlogLayout post={post} Content={Content}>
  <!-- Enhanced SEO meta tags in head -->
  <Fragment slot="head">
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL.href} />
    
    <!-- Article-specific meta tags -->
    <meta name="article:published_time" content={post.data.pubDate.toISOString()} />
    {post.data.updatedDate && (
      <meta name="article:modified_time" content={post.data.updatedDate.toISOString()} />
    )}
    
    <!-- Keywords meta tag -->
    {post.data.tags && post.data.tags.length > 0 && (
      <meta name="keywords" content={post.data.tags.join(", ")} />
    )}
    
    <!-- Reading time meta -->
    <meta name="twitter:label1" content="Reading time" />
    <meta name="twitter:data1" content={`${readingTime} min read`} />
    
    <!-- Word count meta -->
    <meta name="twitter:label2" content="Word count" />
    <meta name="twitter:data2" content={`${wordCount} words`} />
    
    <!-- Enhanced Open Graph tags for articles -->
    <meta property="og:type" content="article" />
    <meta property="article:author" content="StoryHub Author" />
    <meta property="article:section" content="Blog" />
    {post.data.tags && post.data.tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
    
    <!-- Structured data (JSON-LD) -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify(structuredData)} />
    
    <!-- Preload critical resources -->
    {post.data.heroImage && (
      <link rel="preload" as="image" href={post.data.heroImage} />
    )}
    
    <!-- RSS feed discovery -->
    <link rel="alternate" type="application/rss+xml" title="StoryHub RSS Feed" href="/rss.xml" />
  </Fragment>
</BlogLayout>

